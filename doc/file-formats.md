<!--
SPDX-FileCopyrightText: 2005 The unpaper authors

SPDX-License-Identifier: GPL-2.0-only
-->

File Formats
============

`unpaper` gets its image file input and output support from the
[ffmpeg][1] library. PDF input/output is implemented separately via
MuPDF when built with `-Dpdf=enabled`.

The reason for the complexity is to be found in the different pixel
formats that need to be supported. At the time of writing, the
supported pixel formats are `gray8`, `y400a` (aka `ya8`), `rgb24`,
`monoblack`, `monowhite` and `pal8` (_caveat emptor_, see notes in the
output formats).

If you have unsupported files that you think should be supported (for
instance because they are generated by some scanning tool or
hardware), please [open an issue][2].

Output Formats
--------------

For image inputs, `unpaper` outputs PNM by default (PBM/PGM/PPM). The
output format tries to match the pixel format of the source material,
so for a `gray8` or `ya8` file, the output will be `pgm`, while for a
`rgb24` input it will be `ppm`. Both `monoblack` and `monowhite` map to
`pbm`. You can force the output type with `--type pbm|pgm|ppm`.

Because of the way palettes are implemented, an input file in `pal8`
format will output `ppm` files by default. Some FFmpeg builds decode
8-bit grayscale TIFF into `pal8`, which triggers this behavior.

### JPEG and JPEG2000 (CUDA batch only)

When built with CUDA support and nvImageCodec, batch mode can write
JPEG or JPEG2000 directly from GPU memory. Use `.jpg`/`.jpeg` or
`.jp2`/`.j2k`/`.j2c`/`.jpx` extensions in the output filenames. If
CUDA/nvImageCodec is not available, image output remains PNM even if a
JPEG/JP2 extension is used.

Input Formats
-------------

### PNM Family

The PNM family of formats is the original file format supported by
`unpaper` and it includes `pbm` (Portable Bit Map), `pgm` (Portable
Grayscale Map) and `ppm` (Portable Pixel Map) formats. It is used by
Linux scanning tools such as `scanimage` and `scanadf`.

Input support is limited to the most common sub-formats:

 - black and white (`pbm`);
 - grayscale up to 8-bit (`pgm`);
 - RGB colour, up to 24-bit (`ppm`).

Both grayscale and RGB colour images allows a definition of a `MAXVAL`
property that defines the depth of the image. Images at a lower depth
than those supported (8-bit for grayscale, 24-bit for RGB), will be
upconverted. Images at a higher depth are not supported.

While the PNM family supports YUV images, these are not supported by
`unpaper` and no plan is currently out to support them.

### Other FFmpeg-Supported Formats

Many common raster formats (PNG, JPEG, BMP, TIFF, etc.) are supported
as long as FFmpeg can decode them into one of the supported pixel
formats listed above. Support depends on how FFmpeg was built on your
system.

### TIFF

The TIFF format consists of many incompatible sub-formats, so support
depends on your FFmpeg build and the specific TIFF encoding. Some
FFmpeg versions decode 8-bit grayscale TIFF as `pal8`, which `unpaper`
will convert to RGB24 and thus output as `ppm`. Support for alpha and
high-bit-depth TIFF variants also depends on FFmpeg.

Notable missing features in some builds include certain compression
types (e.g. JPEG or LZMA), 4-bit grayscale images, and multi-page TIFFs.

PDF Input/Output
----------------

PDF support is available when built with MuPDF (`-Dpdf=enabled`).
PDF processing is activated when both the input and output filenames
are `.pdf`:

    unpaper input.pdf output.pdf

The PDF pipeline tries to extract the embedded raster image from each
page (JPEG/JP2/JBIG2/PNG/Flate, depending on the file). If extraction
fails or the page geometry does not match the image size, it falls
back to rendering the page at `--pdf-dpi` (default 300).

JBIG2 decoding for 1-bit images requires `jbig2dec` (`-Djbig2=enabled`).
When JBIG2 support is not compiled in, those pages are rendered instead.

PDF output embeds JPEG by default for speed. Use `--pdf-quality=high`
to request JP2 (lossless) output when nvImageCodec with JP2 support is
available; otherwise it falls back to JPEG.

[1]: https://www.ffmpeg.org/
[2]: https://github.com/unpaper/unpaper/issues
